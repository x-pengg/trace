<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>upload</title>
    <link rel='stylesheet' href='/css/style.css' />
</head>
<body>

<div id="container">
<button id="test">ä¸Šä¼ å›¾ç‰‡</button>
</div>
<div id="description">

</div>
<input type="hidden" id="domain" value="<%= domain %>">
<script src="//cdn.bootcss.com/jquery/2.2.0/jquery.js"></script>
<script src="/js/moxie.js"></script>
<script src="/js/plupload_dev.js"></script>
<script src="/js/qiniu.js"></script>
<script type="text/javascript">
   $(function () {
       var uploader = Qiniu.uploader({
           runtimes: 'html5,flash,html4',      // ä¸Šä¼ æ¨¡å¼ï¼Œä¾æ¬¡é€€åŒ–
           browse_button: 'test',         // ä¸Šä¼ é€‰æ‹©çš„ç‚¹é€‰æŒ‰é’®ï¼Œå¿…éœ€
           uptoken_url: '/getUpToken',         // Ajaxè¯·æ±‚uptokençš„Urlï¼Œå¼ºçƒˆå»ºè®®è®¾ç½®ï¼ˆæœåŠ¡ç«¯æä¾›ï¼‰
           uptoken_func: function(file){    // åœ¨éœ€è¦è·å–uptokenæ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«è°ƒç”¨
               console.log('è·å– qiniu token...');
               return uptoken;
           },
           get_new_uptoken: false,             // è®¾ç½®ä¸Šä¼ æ–‡ä»¶çš„æ—¶å€™æ˜¯å¦æ¯æ¬¡éƒ½é‡æ–°è·å–æ–°çš„uptoken
           // downtoken_url: '/downtoken',
           // Ajaxè¯·æ±‚downTokençš„Urlï¼Œç§æœ‰ç©ºé—´æ—¶ä½¿ç”¨ï¼ŒJS-SDKå°†å‘è¯¥åœ°å€POSTæ–‡ä»¶çš„keyå’Œdomainï¼ŒæœåŠ¡ç«¯è¿”å›çš„JSONå¿…é¡»åŒ…å«urlå­—æ®µï¼Œurlå€¼ä¸ºè¯¥æ–‡ä»¶çš„ä¸‹è½½åœ°å€
           // unique_names: true,              // é»˜è®¤falseï¼Œkeyä¸ºæ–‡ä»¶åã€‚è‹¥å¼€å¯è¯¥é€‰é¡¹ï¼ŒJS-SDKä¼šä¸ºæ¯ä¸ªæ–‡ä»¶è‡ªåŠ¨ç”Ÿæˆkeyï¼ˆæ–‡ä»¶åï¼‰
           // save_key: true,                  // é»˜è®¤falseã€‚è‹¥åœ¨æœåŠ¡ç«¯ç”Ÿæˆuptokençš„ä¸Šä¼ ç­–ç•¥ä¸­æŒ‡å®šäº†sava_keyï¼Œåˆ™å¼€å¯ï¼ŒSDKåœ¨å‰ç«¯å°†ä¸å¯¹keyè¿›è¡Œä»»ä½•å¤„ç†
           domain: $('#domain').val(),     // bucketåŸŸåï¼Œä¸‹è½½èµ„æºæ—¶ç”¨åˆ°ï¼Œå¿…éœ€
           container: 'container',             // ä¸Šä¼ åŒºåŸŸDOM IDï¼Œé»˜è®¤æ˜¯browser_buttonçš„çˆ¶å…ƒç´ 
           max_file_size: '10mb',             // æœ€å¤§æ–‡ä»¶ä½“ç§¯é™åˆ¶
           flash_swf_url: 'path/of/plupload/Moxie.swf',  //å¼•å…¥flashï¼Œç›¸å¯¹è·¯å¾„
           max_retries: 3,                     // ä¸Šä¼ å¤±è´¥æœ€å¤§é‡è¯•æ¬¡æ•°
           dragdrop: true,                     // å¼€å¯å¯æ‹–æ›³ä¸Šä¼ 
           drop_element: 'container',          // æ‹–æ›³ä¸Šä¼ åŒºåŸŸå…ƒç´ çš„IDï¼Œæ‹–æ›³æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹åå¯è§¦å‘ä¸Šä¼ 
           chunk_size: '4mb',                  // åˆ†å—ä¸Šä¼ æ—¶ï¼Œæ¯å—çš„ä½“ç§¯
           auto_start: true,                   // é€‰æ‹©æ–‡ä»¶åè‡ªåŠ¨ä¸Šä¼ ï¼Œè‹¥å…³é—­éœ€è¦è‡ªå·±ç»‘å®šäº‹ä»¶è§¦å‘ä¸Šä¼ 
           //x_vars : {
           //    æŸ¥çœ‹è‡ªå®šä¹‰å˜é‡
           //    'time' : function(up,file) {
           //        var time = (new Date()).getTime();
           // do something with 'time'
           //        return time;
           //    },
           //    'size' : function(up,file) {
           //        var size = file.size;
           // do something with 'size'
           //        return size;
           //    }
           //},
           init: {
               'FilesAdded': function(up, files) {
                   plupload.each(files, function(file) {
                       // æ–‡ä»¶æ·»åŠ è¿›é˜Ÿåˆ—åï¼Œå¤„ç†ç›¸å…³çš„äº‹æƒ…
                   });
               },
               'BeforeUpload': function(up, file) {
                   // æ¯ä¸ªæ–‡ä»¶ä¸Šä¼ å‰ï¼Œå¤„ç†ç›¸å…³çš„äº‹æƒ…
               },
               'UploadProgress': function(up, file) {
                   // æ¯ä¸ªæ–‡ä»¶ä¸Šä¼ æ—¶ï¼Œå¤„ç†ç›¸å…³çš„äº‹æƒ…
                   var uploaded = file.loaded;
                   var size = plupload.formatSize(uploaded).toUpperCase();
                   var formatSpeed = plupload.formatSize(file.speed).toUpperCase();
                   var percentage = file.percent;
                   percentage = parseInt(percentage, 10);
                   if (file.status !== plupload.DONE && percentage === 100) {
                       percentage = 99;
                   }
                   console.log("å·²ä¸Šä¼ : " + size + " ä¸Šä¼ é€Ÿåº¦ï¼š " + formatSpeed + "/s  ä¸Šä¼ è¿›åº¦: "+percentage + '%');
               },
               'FileUploaded': function(up, file, info) {
                   var domain = up.getOption('domain'),
                           res = JSON.parse(info),
                           sourceLink = domain +'/'+ res.key;
                   var exifOjb = Qiniu.exif(res.key);
                   if(!exifOjb){
                       alert('ä½ ä¸Šä¼ çš„æ˜¯ä»€ä¹ˆé¬¼ğŸ‘»?');
                       return;
                   }
                   if (!exifOjb.GPSLatitude || !exifOjb.GPSLongitude ||!exifOjb.Model) {
                       var param = {
                           photoUrl: sourceLink
                       }
                   }else{
                       // çº¬åº¦
                       var lat = GPS2Location(exifOjb.GPSLatitude.val);
                       // ç»åº¦
                       var lon = GPS2Location(exifOjb.GPSLongitude.val);

                       var param = {
                           photoUrl: sourceLink,
                           lat: lat,
                           lon: lon,
                           camera: exifOjb.Model.val
                       }

                   }
                   $.post('/savePhoto',param,function (r) {
                       console.log(r)
                   });
                   $('body').append('<p>'+sourceLink+'</p>');
                   $('body').append('<img src="'+sourceLink+'" width="300px" height="300px"/><br/>');
                   $('body').append('<img style="position: absolute;clip: rect(1px auto 270px 0px);" src="http://api.map.baidu.com/staticimage?markers='+lon+','+lat+'&markerStyles=l,W&zoom=12&width=600" />');
               },
               'Error': function(up, err, errTip) {
                   console.error(errTip);
               },
               'UploadComplete': function() {
                   //é˜Ÿåˆ—æ–‡ä»¶å¤„ç†å®Œæ¯•åï¼Œå¤„ç†ç›¸å…³çš„äº‹æƒ…
               },
               'Key': function(up, file) {
                   // è‹¥æƒ³åœ¨å‰ç«¯å¯¹æ¯ä¸ªæ–‡ä»¶çš„keyè¿›è¡Œä¸ªæ€§åŒ–å¤„ç†ï¼Œå¯ä»¥é…ç½®è¯¥å‡½æ•°
                   // è¯¥é…ç½®å¿…é¡»è¦åœ¨unique_names: falseï¼Œsave_key: falseæ—¶æ‰ç”Ÿæ•ˆ

                   var key = 'trace'+new Date().getTime();
                   // do something with key here
                   return key;
               }
           }
       });

       uploader.bind('FileUploaded', function() {
           console.log('hello man,a file is uploaded');
       });

       var GPS2Location = function(str){
 			var arr = str.split(', ');
	        var d = arr[0],
	        f = arr[1],
	        m = arr[2],
	        f = parseFloat(f) + parseFloat(m/60),
	        lc = parseFloat(f/60) + parseFloat(d);
	        return lc;
       }
   })
</script>
</body>
</html>
